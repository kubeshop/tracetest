on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
    paths:
      - server/**

name: Dogfood tracetest
jobs:
  run:
    runs-on: ubuntu-latest
    steps:
    - name: Clone pokeapi
      uses: actions/checkout@v2
      with:
        repository: kubeshop/pokeshop
        path: 'pokeshop'
    - name: Start pokeapi
      run: docker-compose -f pokeshop/api/docker-compose.yml up -d api-ci
    - name: Clone tracetest
      uses: actions/checkout@v2
    - name: Start tracetest
      run: |
        cp server/config.yaml.sample server/config.yaml
        docker-compose pull
        docker-compose up -d tracetest
    - name: Install CLI
      run: |
        mkdir -p $GITHUB_WORKSPACE/bin
        curl -L https://github.com/mathnogueira/tracetest/releases/download/v0.4.6/tracetest-v0.4.6-linux-amd64.tar.gz -O file.tar.gz
        tar -xvf file.tar.gz
        mv tracetest $GITHUB_WORKSPACE/bin
        chmod +x $GITHUB_WORKSPACE/bin/tracetest
        echo "::add-path::$GITHUB_WORKSPACE/bin"
    - name: Configure CLI
      run: |
        echo "scheme: http\nendpoint: localhost:8080" > config.yml
    - name: Run test
      run: tracetest test run --definition tracetesting/create_test.yml --wait-for-result