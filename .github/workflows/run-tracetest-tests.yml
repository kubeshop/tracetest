on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
    paths:
      - server/**

name: Dogfood tracetest
jobs:
  run:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Start tracetest
      run: |
        ls
        cp ./tracetesting/ci/config.yml server/config.yaml
        cp ./tracetesting/ci/tracetest-testing-docker-compose.yml docker-compose.yaml
        docker-compose pull
        docker-compose up -d tracetest
    - name: Install CLI
      run: |
        mkdir -p $GITHUB_WORKSPACE/bin
        curl -L https://github.com/kubeshop/tracetest/releases/download/v0.5.0/tracetest-v0.5.0-linux-amd64.tar.gz --output file.tar.gz
        tar -xvf file.tar.gz
    - name: Configure CLI
      run: |
        echo "scheme: http" > config.yml
        echo "endpoint: localhost:8080" >> config.yml
        cat config.yml
    - name: Run test
      run: ./tracetest test run --definition tracetesting/create_test.yml --wait-for-result