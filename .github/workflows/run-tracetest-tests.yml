on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
    paths:
      - server/**

name: Dogfood tracetest
jobs:
  run:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: Setup go
      uses: actions/setup-go@v3
      with:
        go-version: '^1.18'
    - name: Install CLI
      run: |
        cd cli
        make build
        cd ..
        cp cli/tracetest .
    - name: Configure CLI
      run: |
        echo "scheme: http" > config.yml
        echo "endpoint: localhost:8080" >> config.yml
        cat config.yml
    - name: Start tracetest
      run: |
        cp ./tracetesting/ci/config.yml server/config.yaml
        cp ./tracetesting/ci/tracetest-testing-docker-compose.yml docker-compose.yaml
        docker-compose pull
        docker-compose up -d pokeshop
        docker-compose up -d tracetest
    - name: Run test
      run: |
        cat tracetesting/create_test.yml
        ./tracetest test run --definition tracetesting/create_test.yml --wait-for-result
      env:
        TRACETEST_URL: "http://localhost:8080"
        POKESHOP_URL: http://pokeshop