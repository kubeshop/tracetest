"use strict";(self.webpackChunktracetest_docs=self.webpackChunktracetest_docs||[]).push([[7926],{62838:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>h,frontMatter:()=>a,metadata:()=>o,toc:()=>d});var s=n(74848),r=n(28453);const a={id:"running-tracetest-with-step-functions-terraform",title:".NET Step Functions with AWS X-Ray, AWS Distro for OpenTelemetry, and Terraform",description:"Quick start on how to configure .NET step functions with OpenTelemetry traces, AWS X-Ray as a trace data store, including AWS Distro for OpenTelemetry, and Tracetest for enhancing your E2E and integration tests with trace-based testing.",hide_table_of_contents:!1,keywords:["tracetest","trace-based testing","observability","distributed tracing","testing","dotnet","step functions","aws functions","aws step functions","aws fargate","terraform","aws xray","aws xray tracing","opentelemetry"],image:"https://res.cloudinary.com/djwdcmwdz/image/upload/v1698686403/docs/Blog_Thumbnail_14_rsvkmo.jpg"},i=void 0,o={id:"examples-tutorials/recipes/running-tracetest-with-step-functions-terraform",title:".NET Step Functions with AWS X-Ray, AWS Distro for OpenTelemetry, and Terraform",description:"Quick start on how to configure .NET step functions with OpenTelemetry traces, AWS X-Ray as a trace data store, including AWS Distro for OpenTelemetry, and Tracetest for enhancing your E2E and integration tests with trace-based testing.",source:"@site/docs/examples-tutorials/recipes/running-tracetest-with-step-functions-terraform.mdx",sourceDirName:"examples-tutorials/recipes",slug:"/examples-tutorials/recipes/running-tracetest-with-step-functions-terraform",permalink:"/examples-tutorials/recipes/running-tracetest-with-step-functions-terraform",draft:!1,unlisted:!1,editUrl:"https://github.com/kubeshop/tracetest/blob/main/docs/docs/examples-tutorials/recipes/running-tracetest-with-step-functions-terraform.mdx",tags:[],version:"current",frontMatter:{id:"running-tracetest-with-step-functions-terraform",title:".NET Step Functions with AWS X-Ray, AWS Distro for OpenTelemetry, and Terraform",description:"Quick start on how to configure .NET step functions with OpenTelemetry traces, AWS X-Ray as a trace data store, including AWS Distro for OpenTelemetry, and Tracetest for enhancing your E2E and integration tests with trace-based testing.",hide_table_of_contents:!1,keywords:["tracetest","trace-based testing","observability","distributed tracing","testing","dotnet","step functions","aws functions","aws step functions","aws fargate","terraform","aws xray","aws xray tracing","opentelemetry"],image:"https://res.cloudinary.com/djwdcmwdz/image/upload/v1698686403/docs/Blog_Thumbnail_14_rsvkmo.jpg"},sidebar:"guidesSidebar",previous:{title:"Pokeshop API with AWS X-Ray (Node.js SDK) and AWS Distro for OpenTelemetry",permalink:"/examples-tutorials/recipes/running-tracetest-with-aws-x-ray-pokeshop"},next:{title:"Node.js and Azure Application Insights (Node.js SDK)",permalink:"/examples-tutorials/recipes/running-tracetest-with-azure-app-insights"}},c={},d=[{value:".NET Step Functions Serverless API with AWS X-Ray, AWS Fargate and Tracetest",id:"net-step-functions-serverless-api-with-aws-x-ray-aws-fargate-and-tracetest",level:2},{value:"Services Architecture",id:"services-architecture",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"Project Structure",id:"project-structure",level:2},{value:"1. NET Core Lambda Functions",id:"1-net-core-lambda-functions",level:3},{value:"2. Tracetest",id:"2-tracetest",level:3},{value:"AWS Network",id:"aws-network",level:3},{value:"Tracetest",id:"tracetest",level:2},{value:"Configuring the Tracetest Container",id:"configuring-the-tracetest-container",level:3},{value:"AWS X-Ray",id:"aws-x-ray",level:2},{value:"How does Tracetest reach AWS X-Ray?",id:"how-does-tracetest-reach-aws-x-ray",level:2},{value:"How do traces reach AWS X-Ray?",id:"how-do-traces-reach-aws-x-ray",level:2},{value:"Running the Example",id:"running-the-example",level:2},{value:"Running Trace-based Tests",id:"running-trace-based-tests",level:2},{value:"Learn More",id:"learn-more",level:2}];function l(e){const t={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.admonition,{type:"note",children:(0,s.jsx)(t.p,{children:(0,s.jsx)(t.a,{href:"https://github.com/kubeshop/tracetest/tree/main/examples/tracetest-aws-step-functions",children:"Check out the source code on GitHub here."})})}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.a,{href:"https://tracetest.io/",children:"Tracetest"})," is a testing tool based on ",(0,s.jsx)(t.a,{href:"https://opentelemetry.io/",children:"OpenTelemetry"})," that allows you to test your distributed application. It allows you to use your telemetry data generated by the OpenTelemetry tools to check and assert if your application has the desired behavior defined by your test definitions."]}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.a,{href:"https://www.terraform.io/",children:"Terraform"})," is an infrastructure as code tool that lets you define both cloud and on-prem resources in human-readable configuration files that you can version, reuse and share. You can then use a consistent workflow to provision and manage all of your infrastructure throughout its lifecycle."]}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.a,{href:"https://aws.amazon.com/fargate/",children:"AWS Fargate"})," is a serverless, pay-as-you-go compute engine that lets you focus on building applications without managing servers. AWS Fargate is compatible with both Amazon Elastic Container Service (ECS) and Amazon Elastic Kubernetes Service (EKS)."]}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.a,{href:"https://aws.amazon.com/step-functions",children:"AWS Step Functions"})," is a visual workflow service that helps developers use AWS services to build distributed applications, automate processes, orchestrate microservices and create data and machine learning (ML) pipelines."]}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.a,{href:"https://aws.amazon.com/xray/",children:"AWS X-Ray"})," provides a complete view of requests as they travel through your application and filters visual data across payloads, functions, traces, services, APIs and more with no-code and low-code motions."]}),"\n",(0,s.jsx)(t.h2,{id:"net-step-functions-serverless-api-with-aws-x-ray-aws-fargate-and-tracetest",children:".NET Step Functions Serverless API with AWS X-Ray, AWS Fargate and Tracetest"}),"\n",(0,s.jsxs)(t.p,{children:["The use case you'll see in this recipe is based on ",(0,s.jsx)(t.a,{href:"https://github.com/aws-samples/aws-step-functions-plagiarism-demo-dotnetcore",children:"this .NET demo repository"})," that illustrates how to create a Basic State Machine using Step Functions, Lambda and DynamoDB."]}),"\n",(0,s.jsx)(t.p,{children:"The infrastructure will use X-Ray as the trace data store to receive traces from the NET core lambda functions, SAM as deployment framework for the Step Functions and Terraform to provision the required AWS services to run Tracetest in the cloud."}),"\n",(0,s.jsx)(t.h2,{id:"services-architecture",children:"Services Architecture"}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"AWS Serverless Diagram",src:n(26068).A+"",width:"1710",height:"1180"})}),"\n",(0,s.jsx)(t.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,s.jsxs)(t.p,{children:["You will need ",(0,s.jsx)(t.a,{href:"https://www.terraform.io/",children:"Terraform"}),", a configured instance of the ",(0,s.jsx)(t.a,{href:"https://aws.amazon.com/cli/",children:"AWS CLI"})," and the ",(0,s.jsx)(t.a,{href:"https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/install-sam-cli.html",children:"SAM CLI"})," installed on your machine to run this quick start Step Functions app!"]}),"\n",(0,s.jsx)(t.h2,{id:"project-structure",children:"Project Structure"}),"\n",(0,s.jsxs)(t.p,{children:["The project is divided into two main sections. The ",(0,s.jsx)(t.code,{children:"infra"})," folder includes the basic services and resources that are required to run Tracetest in your AWS account using Terraform as the deployment framework. Meanwhile, the ",(0,s.jsx)(t.code,{children:"src"})," folder includes the code and configuration to create and provision the Step Functions using the SAM framework."]}),"\n",(0,s.jsx)(t.h3,{id:"1-net-core-lambda-functions",children:"1. NET Core Lambda Functions"}),"\n",(0,s.jsxs)(t.p,{children:["The ",(0,s.jsx)(t.code,{children:"src"})," directory includes a separate sub-folder for each of the Lambda functions that are a part of the Step Functions definition, there you can find what steps are taken for each of the checkpoints."]}),"\n",(0,s.jsxs)(t.p,{children:["The State Machine definition can be found in the ",(0,s.jsx)(t.code,{children:"scr/state-machine.asl.json"})," file which is written using the ",(0,s.jsx)(t.a,{href:"https://docs.aws.amazon.com/step-functions/latest/dg/concepts-amazon-states-language.html",children:"AWS States Language"}),"."]}),"\n",(0,s.jsx)(t.h3,{id:"2-tracetest",children:"2. Tracetest"}),"\n",(0,s.jsxs)(t.p,{children:["Under the ",(0,s.jsx)(t.code,{children:"infra"})," folder you'll find the ",(0,s.jsx)(t.code,{children:"tracetest.tf"})," file, which includes the required services and configuration to run Tracetest on AWS Fargate."]}),"\n",(0,s.jsx)(t.h3,{id:"aws-network",children:"AWS Network"}),"\n",(0,s.jsx)(t.p,{children:"To connect all of the services, the example generates a VPC network which includes private and public subnets. Internal services like the Postgres RDS instance are protected behind the VPC and only accessible through a node within the internal network."}),"\n",(0,s.jsxs)(t.p,{children:["There is one ",(0,s.jsx)(t.a,{href:"https://aws.amazon.com/elasticloadbalancing/application-load-balancer/",children:"Public Application Load Balancer"})," which provides access to the Tracetest task instance through port ",(0,s.jsx)(t.code,{children:"11633"}),"."]}),"\n",(0,s.jsx)(t.h2,{id:"tracetest",children:"Tracetest"}),"\n",(0,s.jsxs)(t.p,{children:["The ",(0,s.jsx)(t.code,{children:"infra/tracetest.tf"})," file contains the required services for the Tracetest server which include."]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Postgres RDS"})," - Postgres is a prerequisite for Tracetest to work. It stores trace data when running the trace-based tests."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.a,{href:"https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_definitions.html",children:(0,s.jsx)(t.strong,{children:"Tracetest Task Definition"})})," - The information on how to configure and provision Tracetest using ECS."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.a,{href:"https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs_services.html",children:(0,s.jsx)(t.strong,{children:"ECS Service"})})," - The server provisioning metadata to run the Tracetest Task Definition."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Networking"})," - Security groups, target groups and load balancer listeners required to have Tracetest connected to the rest of the AWS infrastructure."]}),"\n"]}),"\n",(0,s.jsx)(t.h3,{id:"configuring-the-tracetest-container",children:"Configuring the Tracetest Container"}),"\n",(0,s.jsx)(t.p,{children:"The Tracetest docker image supports environment variables as the entry point for the bootstrap configuration. In this case the task definition includes the following:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-json",children:'{\n  "environment" : [\n    // POSTGRES CONNECTION\n    {\n      "name" : "TRACETEST_POSTGRES_HOST",\n      "value" : "${module.db.db_instance_address}"\n    },\n    {\n      "name" : "TRACETEST_POSTGRES_PORT",\n      "value" : "${tostring(module.db.db_instance_port)}"\n    },\n    {\n      "name" : "TRACETEST_POSTGRES_DBNAME",\n      "value" : "${module.db.db_instance_name}"\n    },\n    {\n      "name" : "TRACETEST_POSTGRES_USER",\n      "value" : "${module.db.db_instance_username}"\n    },\n    {\n      "name" : "TRACETEST_POSTGRES_PASSWORD",\n      "value" : "${module.db.db_instance_password}"\n    },\n  ]\n}\n'})}),"\n",(0,s.jsx)(t.h2,{id:"aws-x-ray",children:"AWS X-Ray"}),"\n",(0,s.jsx)(t.p,{children:"This recipe uses AWS X-Ray as the Data Source for the telemetry data. It doesn't require any predefined configuration to start using this service, only needing the correct access for applications to be able to send and fetch information from it."}),"\n",(0,s.jsx)(t.h2,{id:"how-does-tracetest-reach-aws-x-ray",children:"How does Tracetest reach AWS X-Ray?"}),"\n",(0,s.jsx)(t.p,{children:"Tracetest supports the native AWS SDK library to connect to X-Ray to find traces. Currently, the only authentication method supported is manually adding a set of AWS credentials that have access to the X-Ray service from your account.\nThis can be done by either providing them from the initial bootstrap using:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-yaml",children:'---\ntype: DataStore\nspec:\n  name: awsxray\n  type: awsxray\n  awsxray:\n    accessKeyId: <your-accessKeyId>\n    secretAccessKey: <your-secretAccessKey>\n    sessionToken: <your-session-token>\n    region: "us-west-2"\n'})}),"\n",(0,s.jsxs)(t.p,{children:["Or from the Tracetest settings page:\n",(0,s.jsx)(t.img,{alt:"AWS X-Ray Settings",src:n(40277).A+"",width:"1991",height:"905"})]}),"\n",(0,s.jsx)(t.h2,{id:"how-do-traces-reach-aws-x-ray",children:"How do traces reach AWS X-Ray?"}),"\n",(0,s.jsxs)(t.p,{children:["This recipe uses the auto-instrumentation ",(0,s.jsx)(t.a,{href:"https://docs.aws.amazon.com/xray-sdk-for-dotnet/latest/reference/html/N_Amazon_XRay_Recorder_Handlers_AwsSdk.htm",children:"library for .NET"})," which automatically listens to any AWS SDK request and sends the telemetry data to X-Ray."]}),"\n",(0,s.jsxs)(t.p,{children:["To provide the Lambda functions access to X-Ray, the ",(0,s.jsx)(t.code,{children:"arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess"})," AWS managed policy is also added."]}),"\n",(0,s.jsx)(t.h2,{id:"running-the-example",children:"Running the Example"}),"\n",(0,s.jsxs)(t.p,{children:["The first thing you need to do is to provision the Tracetest infrastructure by running the following commands from the ",(0,s.jsx)(t.code,{children:"infra"})," folder:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"terraform init \\\nterraform apply\n"})}),"\n",(0,s.jsxs)(t.p,{children:["After accepting the changes after running the ",(0,s.jsx)(t.code,{children:"terraform apply"})," command and finalizing the infra creation, you can find the output with the required endpoints to continue with tests.\nThe final output from the Terraform command should be a list of endpoints that are similar to the following:"]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"Terraform Step Functions Output",src:n(93357).A+"",width:"913",height:"139"})}),"\n",(0,s.jsxs)(t.p,{children:["You can follow the ",(0,s.jsx)(t.code,{children:"tracetest_url"})," to find the Tracetest UI."]}),"\n",(0,s.jsxs)(t.p,{children:["The second step is adding the AWS credentials for Tracetest to reach X-Ray by following this url ",(0,s.jsx)(t.code,{children:"tracetest_url/settings"}),". Select X-Ray as the data store and update the settings."]}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:"Tip."})," After you add the credentials, you can test the connection by clicking the ",(0,s.jsx)(t.strong,{children:"Test Connection"})," button."]}),"\n",(0,s.jsxs)(t.p,{children:["The third step is to create the Lambda functions and the rest of the services to run the Step Functions by running the following command from the ",(0,s.jsx)(t.code,{children:"src"})," folder:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"sam build \\\nsam deploy --guided\n"})}),"\n",(0,s.jsx)(t.p,{children:"You'll be asked to fill in some details like the app name, email settings and a Sendgrid API key.\nThe output from the previous command should look similar to this:"}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"SAM Step Functions",src:n(13358).A+"",width:"1194",height:"173"})}),"\n",(0,s.jsx)(t.h2,{id:"running-trace-based-tests",children:"Running Trace-based Tests"}),"\n",(0,s.jsx)(t.p,{children:"Now that all of the required services and infra have been created, you can start running trace-based testing by doing the following:"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:["Run this ",(0,s.jsx)(t.code,{children:"sam list stack-outputs --stack-name <your_app_name>"})," command where you can copy the ",(0,s.jsx)(t.code,{children:"StepFunctionsAPIUrl"})," value and add the ",(0,s.jsx)(t.code,{children:"<your_api_endpoint>"})," placeholder from the ",(0,s.jsx)(t.code,{children:"tests/incident.yaml"})," and ",(0,s.jsx)(t.code,{children:"tests/exam.yaml"})," files."]}),"\n",(0,s.jsxs)(t.li,{children:["From the Terraform output, configure the ",(0,s.jsx)(t.a,{href:"https://docs.tracetest.io/cli/configuring-your-cli",children:"Tracetest CLI"})," to point to the public load balancer endpoint with ",(0,s.jsx)(t.code,{children:"tracetest configure --server-url <tracetest_url>"}),"."]}),"\n",(0,s.jsx)(t.li,{children:"Run the tests YAML file using the CLI."}),"\n"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"  tracetest run test -f tests/incident.yaml \\\n  tracetest run test -f tests/exam.yaml \\\n  tracetest run transaction -f tests/transaction.yaml\n"})}),"\n",(0,s.jsxs)(t.ol,{start:"4",children:["\n",(0,s.jsx)(t.li,{children:"Follow the link to find the results."}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"learn-more",children:"Learn More"}),"\n",(0,s.jsxs)(t.p,{children:["Please visit our ",(0,s.jsx)(t.a,{href:"https://github.com/kubeshop/tracetest/tree/main/examples",children:"examples in GitHub"})," and join our ",(0,s.jsx)(t.a,{href:"https://dub.sh/tracetest-community",children:"Slack Community"})," for more info!"]})]})}function h(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},26068:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/aws-step-functions-2ac976fdcc905a02959c81073f996577.png"},40277:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/awsxray-settings-2c5641bea0e40ce72679da99925b8a97.png"},13358:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/sam-step-functions-35d8757498b8638a12a39fe298739212.png"},93357:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/terraform-step-functions-2c02a787a9c756fae747316eb18fb4c5.png"},28453:(e,t,n)=>{n.d(t,{R:()=>i,x:()=>o});var s=n(96540);const r={},a=s.createContext(r);function i(e){const t=s.useContext(a);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),s.createElement(a.Provider,{value:t},e.children)}}}]);