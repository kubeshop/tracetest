"use strict";(self.webpackChunktracetest_docs=self.webpackChunktracetest_docs||[]).push([[6585],{1445:(e,s,t)=>{t.r(s),t.d(s,{assets:()=>r,contentTitle:()=>o,default:()=>p,frontMatter:()=>i,metadata:()=>c,toc:()=>d});var n=t(74848),a=t(28453);const i={id:"get-pokemon-by-id",title:"Pokeshop API - Get Pokemon by ID",description:"As a testing ground, the Tracetest team has implemented a sample API instrumented with OpenTelemetry around the PokeAPI. This use case retrieves a specific Pokemon from the cache if it is cached or from the database (Postgres) also populating the cache.",hide_table_of_contents:!1,keywords:["tracetest","trace-based testing","observability","distributed tracing","testing"],image:"https://res.cloudinary.com/djwdcmwdz/image/upload/v1698686403/docs/Blog_Thumbnail_14_rsvkmo.jpg"},o=void 0,c={id:"live-examples/pokeshop/use-cases/get-pokemon-by-id",title:"Pokeshop API - Get Pokemon by ID",description:"As a testing ground, the Tracetest team has implemented a sample API instrumented with OpenTelemetry around the PokeAPI. This use case retrieves a specific Pokemon from the cache if it is cached or from the database (Postgres) also populating the cache.",source:"@site/docs/live-examples/pokeshop/use-cases/get-pokemon-by-id.mdx",sourceDirName:"live-examples/pokeshop/use-cases",slug:"/live-examples/pokeshop/use-cases/get-pokemon-by-id",permalink:"/live-examples/pokeshop/use-cases/get-pokemon-by-id",draft:!1,unlisted:!1,editUrl:"https://github.com/kubeshop/tracetest/blob/main/docs/docs/live-examples/pokeshop/use-cases/get-pokemon-by-id.mdx",tags:[],version:"current",frontMatter:{id:"get-pokemon-by-id",title:"Pokeshop API - Get Pokemon by ID",description:"As a testing ground, the Tracetest team has implemented a sample API instrumented with OpenTelemetry around the PokeAPI. This use case retrieves a specific Pokemon from the cache if it is cached or from the database (Postgres) also populating the cache.",hide_table_of_contents:!1,keywords:["tracetest","trace-based testing","observability","distributed tracing","testing"],image:"https://res.cloudinary.com/djwdcmwdz/image/upload/v1698686403/docs/Blog_Thumbnail_14_rsvkmo.jpg"},sidebar:"guidesSidebar",previous:{title:"Pokeshop API - List Pokemon",permalink:"/live-examples/pokeshop/use-cases/list-pokemon"},next:{title:"Pokeshop API - Import Pokemon",permalink:"/live-examples/pokeshop/use-cases/import-pokemon"}},r={},d=[{value:"Building a Test for the Described Scenarios",id:"building-a-test-for-the-described-scenarios",level:2},{value:"Traces",id:"traces",level:3},{value:"Assertions",id:"assertions",level:3},{value:"Test Definition",id:"test-definition",level:3},{value:"Cache Miss Scenario",id:"cache-miss-scenario",level:4},{value:"Cache Miss Scenario",id:"cache-miss-scenario-1",level:4}];function h(e){const s={a:"a",code:"code",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(s.p,{children:"This use case retrieves a specific Pokemon from the cache if it is cached or from the database (Postgres) also populating the cache. The idea of this query is to showcase a straightforward scenario, where the API layer receives a request from the outside and needs to evaluate a different behavior depending of its dependencies."}),"\n",(0,n.jsx)(s.mermaid,{value:"sequenceDiagram\n    participant Endpoint as GET /pokemon/:id\n    participant API as API\n    participant Database as Postgres\n    participant Cache as Redis\n    \n    Endpoint->>API: request\n\n    API->>Cache: query cache\n    Cache--\x3e>API: cache response\n\n    alt cache hit\n      API--\x3e>Endpoint: 200 OK <br> <Pokemon object>\n    else cache miss\n      API->>Database: get specific of pokemon\n      Database--\x3e>API: pokemon\n\n      API->>Cache: populate cache\n      Cache--\x3e>API: ok\n\n      API--\x3e>Endpoint: 200 OK <br> <Pokemon object>\n    end"}),"\n",(0,n.jsxs)(s.p,{children:["You can trigger this use case by calling the endpoint ",(0,n.jsx)(s.code,{children:"GET /pokemon/25"})," without payload and should receive a payload similar to this:"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-json",children:'{\n  "id":  25,\n  "name":  "pikachu",\n  "type":  "electric",\n  "imageUrl":  "https://assets.pokemon.com/assets/cms2/img/pokedex/full/025.png",\n  "isFeatured":  true\n}\n'})}),"\n",(0,n.jsx)(s.h2,{id:"building-a-test-for-the-described-scenarios",children:"Building a Test for the Described Scenarios"}),"\n",(0,n.jsxs)(s.p,{children:["Using Tracetest, we can ",(0,n.jsx)(s.a,{href:"/web-ui/creating-tests",children:"create two tests"})," that will execute an API call on ",(0,n.jsx)(s.code,{children:"GET /pokemon/25"})," and validate the following scenarios:"]}),"\n",(0,n.jsxs)(s.ol,{children:["\n",(0,n.jsxs)(s.li,{children:[(0,n.jsx)(s.strong,{children:"An API call with a cache hit."}),"\n",(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsx)(s.li,{children:"The API should return a valid result with HTTP 200 OK."}),"\n",(0,n.jsx)(s.li,{children:"The cache should be queried."}),"\n",(0,n.jsx)(s.li,{children:"The database should not be queried."}),"\n"]}),"\n"]}),"\n",(0,n.jsxs)(s.li,{children:[(0,n.jsx)(s.strong,{children:"An API call with a cache miss."}),"\n",(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsx)(s.li,{children:"The API should return a valid result with HTTP 200 OK."}),"\n",(0,n.jsx)(s.li,{children:"The cache should be queried."}),"\n",(0,n.jsx)(s.li,{children:"The cache should be populated."}),"\n",(0,n.jsx)(s.li,{children:"The database should be queried."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,n.jsx)(s.h3,{id:"traces",children:"Traces"}),"\n",(0,n.jsx)(s.p,{children:"Running these tests for the first time will create an Observability trace with two different shapes, depending on the cache situation."}),"\n",(0,n.jsxs)(s.ol,{children:["\n",(0,n.jsxs)(s.li,{children:["\n",(0,n.jsxs)(s.p,{children:[(0,n.jsx)(s.strong,{children:"Cache Miss"})," where we can see spans from the API, database, and cache:\n",(0,n.jsx)(s.img,{src:t(14523).A+"",width:"2232",height:"1344"})]}),"\n"]}),"\n",(0,n.jsxs)(s.li,{children:["\n",(0,n.jsxs)(s.p,{children:[(0,n.jsx)(s.strong,{children:"Cache Hit"})," where we can see spans from the API and cache:\n",(0,n.jsx)(s.img,{src:t(48700).A+"",width:"1340",height:"1330"})]}),"\n"]}),"\n"]}),"\n",(0,n.jsx)(s.h3,{id:"assertions",children:"Assertions"}),"\n",(0,n.jsxs)(s.p,{children:["With this trace, we can build ",(0,n.jsx)(s.a,{href:"/concepts/assertions",children:"assertions"})," on Tracetest and validate API, cache, and database responses:"]}),"\n",(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsxs)(s.li,{children:["\n",(0,n.jsxs)(s.p,{children:["[Both Cases] The API should return a valid result with HTTP 200 OK.\n",(0,n.jsx)(s.img,{src:t(18746).A+"",width:"2852",height:"848"})]}),"\n"]}),"\n",(0,n.jsxs)(s.li,{children:["\n",(0,n.jsxs)(s.p,{children:["[Both Cases] The cache should be queried.\n",(0,n.jsx)(s.img,{src:t(8576).A+"",width:"2840",height:"752"})]}),"\n"]}),"\n",(0,n.jsxs)(s.li,{children:["\n",(0,n.jsxs)(s.p,{children:["[Cache Hit] The database should not be queried.\n",(0,n.jsx)(s.img,{src:t(92231).A+"",width:"2794",height:"822"})]}),"\n"]}),"\n",(0,n.jsxs)(s.li,{children:["\n",(0,n.jsxs)(s.p,{children:["[Cache Miss] The cache should be populated.\n",(0,n.jsx)(s.img,{src:t(20444).A+"",width:"2850",height:"756"})]}),"\n"]}),"\n",(0,n.jsxs)(s.li,{children:["\n",(0,n.jsxs)(s.p,{children:["[Cache Miss] The database should be queried.\n",(0,n.jsx)(s.img,{src:t(13779).A+"",width:"2830",height:"816"})]}),"\n"]}),"\n"]}),"\n",(0,n.jsx)(s.p,{children:"Now you can validate this entire use case."}),"\n",(0,n.jsx)(s.h3,{id:"test-definition",children:"Test Definition"}),"\n",(0,n.jsxs)(s.p,{children:["If you want to replicate those tests on Tracetest, you can replicate these steps on our Web UI or using our CLI, saving one of the test definitions as the file ",(0,n.jsx)(s.code,{children:"test-definition.yml"})," and running:"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-sh",children:"tracetest run test -f test-definition.yml\n"})}),"\n",(0,n.jsx)(s.h4,{id:"cache-miss-scenario",children:"Cache Miss Scenario"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-yaml",children:'type: Test\nspec:\n  name: Pokeshop - Get Pokemon by ID [cache miss scenario]\n  trigger:\n    type: http\n    httpRequest:\n      url: http://demo-pokemon-api.demo/pokemon/${var:POKEMON_ID}\n      method: GET\n      headers:\n      - key: Content-Type\n        value: application/json\n  specs:\n  - selector: span[tracetest.span.type="http" http.method="GET"]\n    assertions:\n    - attr:http.status_code  =  200\n    - attr:http.response.body | json_path \'$.id\'  =  \'${var:POKEMON_ID}\'\n  - selector: span[tracetest.span.type="database" db.system="redis" db.operation="get"]\n    assertions:\n    - attr:name  =  "get pokemon-${var:POKEMON_ID}"\n  - selector: span[tracetest.span.type="database" db.system="redis" db.operation="set"]\n    assertions:\n    - attr:name = "set pokemon-${var:POKEMON_ID}"\n  - selector: |-\n      span[tracetest.span.type="database" name="findOne pokeshop.pokemon"\n            db.system="postgres" db.name="pokeshop" db.operation="findOne" db.sql.table="pokemon"]\n    assertions:\n    - attr:tracetest.selected_spans.count > 0\n'})}),"\n",(0,n.jsx)(s.h4,{id:"cache-miss-scenario-1",children:"Cache Miss Scenario"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-yml",children:'type: Test\nspec:\n  name: Pokeshop - Get Pokemon by ID [cache hit scenario]\n  trigger:\n    type: http\n    httpRequest:\n      url: http://demo-pokemon-api.demo/pokemon/${var:POKEMON_ID}\n      method: GET\n      headers:\n      - key: Content-Type\n        value: application/json\n  specs:\n  - selector: span[tracetest.span.type="http" http.method="GET"]\n    assertions:\n    - attr:http.status_code  =  200\n    - attr:http.response.body | json_path \'$.id\'  =  "${var:POKEMON_ID}"\n  - selector: span[tracetest.span.type="database" db.system="redis" db.operation="get"]\n    assertions:\n    - attr:name = "get pokemon-${var:POKEMON_ID}"\n    - attr:db.result | json_path \'$.id\' = "${var:POKEMON_ID}"\n  - selector: |-\n      span[tracetest.span.type="database" name="findOne pokeshop.pokemon"\n            db.system="postgres" db.name="pokeshop" db.operation="findOne" db.sql.table="pokemon"]\n    assertions:\n    - attr:tracetest.selected_spans.count  =  0\n'})})]})}function p(e={}){const{wrapper:s}={...(0,a.R)(),...e.components};return s?(0,n.jsx)(s,{...e,children:(0,n.jsx)(h,{...e})}):h(e)}},18746:(e,s,t)=>{t.d(s,{A:()=>n});const n=t.p+"assets/images/get-pokemon-by-id-api-test-spec-28803fd335ae3e027dbe1e09d3ec8cb9.png"},92231:(e,s,t)=>{t.d(s,{A:()=>n});const n=t.p+"assets/images/get-pokemon-by-id-db-no-query-test-spec-8ed173ccda4aeb6df1d14f8e50c30023.png"},13779:(e,s,t)=>{t.d(s,{A:()=>n});const n=t.p+"assets/images/get-pokemon-by-id-db-query-test-spec-58f77885b9ae58ae62ccb836f1766c94.png"},8576:(e,s,t)=>{t.d(s,{A:()=>n});const n=t.p+"assets/images/get-pokemon-by-id-redis-query-test-spec-9a71452c55098fd744926666c9343170.png"},20444:(e,s,t)=>{t.d(s,{A:()=>n});const n=t.p+"assets/images/get-pokemon-by-id-redis-set-test-spec-e8a50d2f17ca3604bfaa10054d19dd0d.png"},48700:(e,s,t)=>{t.d(s,{A:()=>n});const n=t.p+"assets/images/get-pokemon-by-id-trace-cachehit-d3709b282862f0c259c6e4ac212b856b.png"},14523:(e,s,t)=>{t.d(s,{A:()=>n});const n=t.p+"assets/images/get-pokemon-by-id-trace-cachemiss-05b6015135529457df14833d58199f2b.png"},28453:(e,s,t)=>{t.d(s,{R:()=>o,x:()=>c});var n=t(96540);const a={},i=n.createContext(a);function o(e){const s=n.useContext(i);return n.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function c(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),n.createElement(i.Provider,{value:s},e.children)}}}]);