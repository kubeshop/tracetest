"use strict";(self.webpackChunktracetest_docs=self.webpackChunktracetest_docs||[]).push([[2799],{44635:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>h,frontMatter:()=>a,metadata:()=>o,toc:()=>l});var r=n(74848),s=n(28453);const a={id:"running-tracetest-with-aws-terraform",title:"Serverless Node.js and Jaeger with Terraform",description:"Quick start on how to configure a Serverless Node.js app on AWS Lambda with OpenTelemetry traces and Tracetest for E2E and integration tests. Uses Jaeger as a trace data store and Terraform for infrastructure management.",hide_table_of_contents:!1,keywords:["tracetest","trace-based testing","observability","distributed tracing","testing","jaeger","jaeger tracing","jaeger observability","tracing","serverless","aws fargate","aws","opentelemetry"],image:"https://res.cloudinary.com/djwdcmwdz/image/upload/v1698686403/docs/Blog_Thumbnail_14_rsvkmo.jpg"},i=void 0,o={id:"examples-tutorials/recipes/running-tracetest-with-aws-terraform",title:"Serverless Node.js and Jaeger with Terraform",description:"Quick start on how to configure a Serverless Node.js app on AWS Lambda with OpenTelemetry traces and Tracetest for E2E and integration tests. Uses Jaeger as a trace data store and Terraform for infrastructure management.",source:"@site/docs/examples-tutorials/recipes/running-tracetest-with-aws-terraform.mdx",sourceDirName:"examples-tutorials/recipes",slug:"/examples-tutorials/recipes/running-tracetest-with-aws-terraform",permalink:"/examples-tutorials/recipes/running-tracetest-with-aws-terraform",draft:!1,unlisted:!1,editUrl:"https://github.com/kubeshop/tracetest/blob/main/docs/docs/examples-tutorials/recipes/running-tracetest-with-aws-terraform.mdx",tags:[],version:"current",frontMatter:{id:"running-tracetest-with-aws-terraform",title:"Serverless Node.js and Jaeger with Terraform",description:"Quick start on how to configure a Serverless Node.js app on AWS Lambda with OpenTelemetry traces and Tracetest for E2E and integration tests. Uses Jaeger as a trace data store and Terraform for infrastructure management.",hide_table_of_contents:!1,keywords:["tracetest","trace-based testing","observability","distributed tracing","testing","jaeger","jaeger tracing","jaeger observability","tracing","serverless","aws fargate","aws","opentelemetry"],image:"https://res.cloudinary.com/djwdcmwdz/image/upload/v1698686403/docs/Blog_Thumbnail_14_rsvkmo.jpg"},sidebar:"guidesSidebar",previous:{title:"Node.js and Jaeger",permalink:"/examples-tutorials/recipes/running-tracetest-with-jaeger"},next:{title:"Node.js and OpenSearch",permalink:"/examples-tutorials/recipes/running-tracetest-with-opensearch"}},c={},l=[{value:"Sample Node.js Serverless API with Jaeger, OpenTelemetry, AWS Fargate and Tracetest",id:"sample-nodejs-serverless-api-with-jaeger-opentelemetry-aws-fargate-and-tracetest",level:2},{value:"Services Architecture",id:"services-architecture",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"Project Structure",id:"project-structure",level:2},{value:"1. Node.js Serverless API",id:"1-nodejs-serverless-api",level:3},{value:"2. Tracetest",id:"2-tracetest",level:3},{value:"3. Jaeger",id:"3-jaeger",level:3},{value:"AWS Network",id:"aws-network",level:3},{value:"Node.js Serverless API",id:"nodejs-serverless-api",level:2},{value:"Tracetest",id:"tracetest",level:2},{value:"Configuring the Tracetest Container",id:"configuring-the-tracetest-container",level:3},{value:"Jaeger",id:"jaeger",level:2},{value:"Jaeger OTLP Endpoints",id:"jaeger-otlp-endpoints",level:3},{value:"Jaeger GRPC API Endpoint",id:"jaeger-grpc-api-endpoint",level:3},{value:"How Does Tracetest Reach Jaeger?",id:"how-does-tracetest-reach-jaeger",level:2},{value:"How Do Traces Reach Jaeger?",id:"how-do-traces-reach-jaeger",level:2},{value:"Running the Example",id:"running-the-example",level:2},{value:"Running Trace-based Tests",id:"running-trace-based-tests",level:2},{value:"Learn More",id:"learn-more",level:2}];function d(e){const t={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.admonition,{type:"note",children:(0,r.jsx)(t.p,{children:(0,r.jsx)(t.a,{href:"https://github.com/kubeshop/tracetest/tree/main/examples/tracetest-aws-terraform-serverless",children:"Check out the source code on GitHub here."})})}),"\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.a,{href:"https://tracetest.io/",children:"Tracetest"})," is a testing tool based on ",(0,r.jsx)(t.a,{href:"https://opentelemetry.io/",children:"OpenTelemetry"})," that allows you to test your distributed application. It allows you to use data from distributed traces generated by OpenTelemetry to validate and assert if your application has the desired behavior defined by your test definitions."]}),"\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.a,{href:"https://www.jaegertracing.io/",children:"Jaeger"})," is an open-source, end-to-end distributed tracing solution. It allows you to monitor and troubleshoot transactions in complex distributed systems. It was developed and open sourced by Uber Technologies. Jaeger provides a distributed tracing solution to enable transactions across multiple heterogeneous systems or microservices to be tracked and displayed as a cascading series of spans."]}),"\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.a,{href:"https://www.terraform.io/",children:"Terraform"})," is an infrastructure as code tool that lets you define both cloud and on-prem resources in human-readable configuration files that you can version, reuse, and share. You can then use a consistent workflow to provision and manage all of your infrastructure throughout its lifecycle."]}),"\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.a,{href:"https://aws.amazon.com/fargate/",children:"AWS Fargate"})," is a serverless, pay-as-you-go compute engine that lets you focus on building applications without managing servers. AWS Fargate is compatible with both Amazon Elastic Container Service (ECS) and Amazon Elastic Kubernetes Service (EKS)."]}),"\n",(0,r.jsx)(t.h2,{id:"sample-nodejs-serverless-api-with-jaeger-opentelemetry-aws-fargate-and-tracetest",children:"Sample Node.js Serverless API with Jaeger, OpenTelemetry, AWS Fargate and Tracetest"}),"\n",(0,r.jsx)(t.p,{children:"This is a simple quick start guide on how to deploy a Node.js Serverless API to use OpenTelemetry instrumentation with traces and Tracetest for enhancing your E2E and integration tests with trace-based testing. The infrastructure will use Jaeger as the trace data store, and OpenTelemetry Collector to receive traces from the Node.js app and Terraform to provision the required AWS services to run Tracetest in the cloud."}),"\n",(0,r.jsx)(t.h2,{id:"services-architecture",children:"Services Architecture"}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{alt:"Terraform Serverless Diagram",src:n(13825).A+"",width:"1570",height:"1220"})}),"\n",(0,r.jsx)(t.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,r.jsxs)(t.p,{children:["You will need ",(0,r.jsx)(t.a,{href:"https://www.terraform.io/",children:"Terraform"}),", a configured instance of the ",(0,r.jsx)(t.a,{href:"https://aws.amazon.com/cli/",children:"AWS CLI"})," installed on your machine to run this quick start Serverless API!"]}),"\n",(0,r.jsx)(t.h2,{id:"project-structure",children:"Project Structure"}),"\n",(0,r.jsxs)(t.p,{children:["The project is built with Terraform. It contains multiple ",(0,r.jsx)(t.code,{children:".tf"})," files where each part of the infra is divided."]}),"\n",(0,r.jsx)(t.h3,{id:"1-nodejs-serverless-api",children:"1. Node.js Serverless API"}),"\n",(0,r.jsxs)(t.p,{children:["The ",(0,r.jsx)(t.code,{children:"src"})," folder is the root directory that contains the Node.js files for both the API and the OpenTelemetry instrumentation.\nThe infrastructure required to run the serverless API can be found as part of the ",(0,r.jsx)(t.code,{children:"api.tf"})," file."]}),"\n",(0,r.jsx)(t.h3,{id:"2-tracetest",children:"2. Tracetest"}),"\n",(0,r.jsxs)(t.p,{children:["The ",(0,r.jsx)(t.code,{children:"tracetest.tf"})," file contains the different services and dependencies to run the Tracetest server using AWS Fargate."]}),"\n",(0,r.jsx)(t.h3,{id:"3-jaeger",children:"3. Jaeger"}),"\n",(0,r.jsxs)(t.p,{children:["Inside the ",(0,r.jsx)(t.code,{children:"jaeger.tf"})," file you'll find the required services to run them all in one instance using AWS Fargate."]}),"\n",(0,r.jsx)(t.h3,{id:"aws-network",children:"AWS Network"}),"\n",(0,r.jsx)(t.p,{children:"To connect all of the services, the example generates a VPC network which includes private and public subnets. Internal services like the Postgres RDS instance are protected behind the VPC and only accessible through a node within the internal network."}),"\n",(0,r.jsxs)(t.p,{children:["There are two ",(0,r.jsx)(t.a,{href:"https://aws.amazon.com/elasticloadbalancing/application-load-balancer/",children:"Application Load Balancers"}),", a public balancer which provides access to the Tracetest task instance through port ",(0,r.jsx)(t.code,{children:"11633"})," and to the Jaeger UI from ",(0,r.jsx)(t.code,{children:"16686"}),"."]}),"\n",(0,r.jsx)(t.p,{children:"The second is an internal load balancer that allows the instrumented Node.js Lambda functions connect to the Jaeger OTLP endpoint using a DNS instead of an IP."}),"\n",(0,r.jsx)(t.h2,{id:"nodejs-serverless-api",children:"Node.js Serverless API"}),"\n",(0,r.jsxs)(t.p,{children:["The Node.js Serverless API is a simple Lambda function, contained in the ",(0,r.jsx)(t.code,{children:"src/hello.js"})," file."]}),"\n",(0,r.jsxs)(t.p,{children:["The OpenTelemetry tracing is contained in the ",(0,r.jsx)(t.code,{children:"src/tracing.js"})," file.\nTraces will be sent to the Jaeger OpenTelemetry Collector Endpoint."]}),"\n",(0,r.jsxs)(t.p,{children:["Here's the content of the ",(0,r.jsx)(t.code,{children:"tracing.js"})," file:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-js",children:'const { Resource } = require("@opentelemetry/resources");\nconst api = require("@opentelemetry/api");\nconst { BatchSpanProcessor } = require("@opentelemetry/sdk-trace-base");\nconst { OTLPTraceExporter } = require("@opentelemetry/exporter-trace-otlp-http");\nconst { NodeTracerProvider } = require("@opentelemetry/sdk-trace-node");\nconst { registerInstrumentations } = require("@opentelemetry/instrumentation");\nconst { getNodeAutoInstrumentations } = require("@opentelemetry/auto-instrumentations-node");\nconst { SemanticResourceAttributes } = require("@opentelemetry/semantic-conventions");\n\nconst provider = new NodeTracerProvider({\n  resource: new Resource({\n    [SemanticResourceAttributes.SERVICE_NAME]: "tracetest",\n  }),\n});\nconst spanProcessor = new BatchSpanProcessor(new OTLPTraceExporter());\n\nprovider.addSpanProcessor(spanProcessor);\nprovider.register();\n\nregisterInstrumentations({\n  instrumentations: [\n    getNodeAutoInstrumentations({\n      "@opentelemetry/instrumentation-aws-lambda": {\n        disableAwsContextPropagation: true,\n        eventContextExtractor: (event) => {\n          event.headers.traceparent = event.headers.Traceparent;\n          const eventContext = api.propagation.extract(api.context.active(), event.headers);\n\n          return eventContext;\n        },\n      },\n    }),\n  ],\n});\n'})}),"\n",(0,r.jsx)(t.p,{children:"The hostname for the Jaeger OTLP Endpoint will be:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:["HTTP: ",(0,r.jsx)(t.code,{children:"http://<internal_load_balancer_dns_name>:4318"})]}),"\n"]}),"\n",(0,r.jsx)(t.p,{children:"Enabling the tracer is done by adding an environment variable to the lambda function."}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",children:'NODE_OPTIONS="--require tracing.js"\n'})}),"\n",(0,r.jsx)(t.h2,{id:"tracetest",children:"Tracetest"}),"\n",(0,r.jsxs)(t.p,{children:["The ",(0,r.jsx)(t.code,{children:"tracetest.tf"})," file contains the required services for the Tracetest server which include."]}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"Postgres RDS"})," - Postgres is a prerequisite for Tracetest to work. It stores the trace-based tests you create, information about prior test runs and other data that Tracetest needs."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"Tracetest Task Definition"})," - The information on how to configure and provision Tracetest using ECS."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.a,{href:"https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs_services.html",children:(0,r.jsx)(t.strong,{children:"ECS Service"})})," - The server provisioning metadata to run the Tracetest Task Definition."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.strong,{children:"Networking"})," - Security groups, target groups and load balancer listeners required to have Tracetest connected to the rest of the AWS infrastructure."]}),"\n"]}),"\n",(0,r.jsx)(t.h3,{id:"configuring-the-tracetest-container",children:"Configuring the Tracetest Container"}),"\n",(0,r.jsx)(t.p,{children:"The Tracetest Docker image supports environment variables as the entry point for the bootstrap configuration, in this case, the task definition includes the following:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-json",children:'{\n  "environment" : [\n    // POSTGRES CONNECTION\n    {\n      "name" : "TRACETEST_POSTGRES_HOST",\n      "value" : "${module.db.db_instance_address}"\n    },\n    {\n      "name" : "TRACETEST_POSTGRES_PORT",\n      "value" : "${tostring(module.db.db_instance_port)}"\n    },\n    {\n      "name" : "TRACETEST_POSTGRES_DBNAME",\n      "value" : "${module.db.db_instance_name}"\n    },\n    {\n      "name" : "TRACETEST_POSTGRES_USER",\n      "value" : "${module.db.db_instance_username}"\n    },\n    {\n      "name" : "TRACETEST_POSTGRES_PASSWORD",\n      "value" : "${module.db.db_instance_password}"\n    },\n    // DATA STORE PROVISIONING\n    {\n      "name" : "TRACETEST_PROVISIONING",\n      "value" : base64encode(local.provisioning)\n    }\n  ]\n}\n'})}),"\n",(0,r.jsx)(t.h2,{id:"jaeger",children:"Jaeger"}),"\n",(0,r.jsxs)(t.p,{children:["Similar to the Tracetest setup, there is a file called ",(0,r.jsx)(t.code,{children:"jaeger.tf"})," which contains a basic setup to run the all-in-one Jaeger image using AWS Fargate. In this case, it includes networking rules for the internal and external load balancers, so we can provide a way for both the Node.js Lambdas and Tracetest to have access to the API endpoints from within the VPC while providing public access to the UI."]}),"\n",(0,r.jsx)(t.h3,{id:"jaeger-otlp-endpoints",children:"Jaeger OTLP Endpoints"}),"\n",(0,r.jsx)(t.p,{children:"The latest version of Jaeger supports enabling OpenTelemetry endpoints by including the following:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-json",children:'"environment" : [{\n  "name" : "COLLECTOR_OTLP_ENABLED",\n  "value" : "true"\n}],\n'})}),"\n",(0,r.jsx)(t.h3,{id:"jaeger-grpc-api-endpoint",children:"Jaeger GRPC API Endpoint"}),"\n",(0,r.jsx)(t.p,{children:"As Tracetest uses GRPC to interact with the Jaeger API and load balancers only support the HTTPS protocol for this type of endpoints, we need to include a certificate to the load balancer listener to go around this requirement."}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-tf",children:'resource "aws_lb_listener" "tracetest-jaeger-api-alb-listener" {\n  load_balancer_arn = aws_lb.internal_tracetest_alb.arn\n  port              = "16685"\n  protocol          = "HTTPS"\n  certificate_arn   = aws_acm_certificate.cert.arn\n\n  default_action {\n    type             = "forward"\n    target_group_arn = aws_lb_target_group.tracetest-jaeger-api-tg.arn\n  }\n}\n\nresource "tls_private_key" "tracetest_private_key" {\n  algorithm = "RSA"\n}\n\nresource "tls_self_signed_cert" "tracetest_self_signed_cert" {\n  private_key_pem = tls_private_key.tracetest_private_key.private_key_pem\n\n  subject {\n    common_name  = "tracetest.com"\n    organization = "Tracetest"\n  }\n\n  validity_period_hours = 720\n\n  allowed_uses = [\n    "key_encipherment",\n    "digital_signature",\n    "server_auth",\n  ]\n}\n\nresource "aws_acm_certificate" "cert" {\n  private_key      = tls_private_key.tracetest_private_key.private_key_pem\n  certificate_body = tls_self_signed_cert.tracetest_self_signed_cert.cert_pem\n}\n'})}),"\n",(0,r.jsx)(t.h2,{id:"how-does-tracetest-reach-jaeger",children:"How Does Tracetest Reach Jaeger?"}),"\n",(0,r.jsxs)(t.p,{children:["The provisioning configuration for Tracetest can be found in the ",(0,r.jsx)(t.code,{children:"variables.tf"})," file under the ",(0,r.jsx)(t.code,{children:"locals"})," configuration which uses the internal load balancer DNS endpoint to build the data store entry."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-tf",children:"provisioning = <<EOF\n---\ntype: PollingProfile\nspec:\n  name: default\n  strategy: periodic\n  default: true\n  periodic:\n    retryDelay: 5s\n    timeout: 10m\n\n---\ntype: DataStore\nspec:\n  name: jaeger\n  type: jaeger\n  jaeger:\n    endpoint: ${aws_lb.internal_tracetest_alb.dns_name}:16685\n    tls:\n      insecure_skip_verify: true\n  EOF\n\n  tags = {\n    Name    = local.name\n    Example = local.name\n  }\n}\n\n  EOF\n"})}),"\n",(0,r.jsx)(t.h2,{id:"how-do-traces-reach-jaeger",children:"How Do Traces Reach Jaeger?"}),"\n",(0,r.jsxs)(t.p,{children:["Similar to the Tracetest provisioning configuration, you can find the environment entry in the ",(0,r.jsx)(t.code,{children:"api.tf"})," file that uses the internal load balancer DNS endpoint for the ",(0,r.jsx)(t.code,{children:"OTEL_EXPORTER_OTLP_ENDPOINT"})," entry."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-tf",children:'environment {\n    variables = {\n      NODE_OPTIONS                = "--require tracing.js"\n      OTEL_EXPORTER_OTLP_ENDPOINT = "http://${aws_lb.internal_tracetest_alb.dns_name}:4318"\n    }\n  }\n'})}),"\n",(0,r.jsx)(t.h2,{id:"running-the-example",children:"Running the Example"}),"\n",(0,r.jsx)(t.p,{children:"To create the AWS infrastructure using Terraform you can simply run:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",children:"terraform init \\\nterraform apply\n"})}),"\n",(0,r.jsxs)(t.p,{children:["After accepting the changes after running the ",(0,r.jsx)(t.code,{children:"terraform apply"})," command and finalizing the infra creation you can find the set of output with the required endpoints to continue with some tests.\nThe final output from the Terraform command should be a list of endpoints that is similar to the following:"]}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{alt:"Terraform Outputs",src:n(26376).A+"",width:"991",height:"220"})}),"\n",(0,r.jsx)(t.h2,{id:"running-trace-based-tests",children:"Running Trace-based Tests"}),"\n",(0,r.jsx)(t.p,{children:"Now that all of the required services and infra have been created, you can start running some Trace-based testing by doing the following:"}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsxs)(t.li,{children:["From the Terraform output you can copy the ",(0,r.jsx)(t.code,{children:"api_endpoint"})," and replace the ",(0,r.jsx)(t.code,{children:"<your_api_endpoint>"})," placeholder from the ",(0,r.jsx)(t.code,{children:"tests/test.yaml"})," file."]}),"\n",(0,r.jsxs)(t.li,{children:["Configure the ",(0,r.jsx)(t.a,{href:"https://docs.tracetest.io/cli/configuring-your-cli",children:"Tracetest CLI"})," to point to the public load balancer endpoint with ",(0,r.jsx)(t.code,{children:"tracetest configure --server-url <tracetest_url>"}),"."]}),"\n",(0,r.jsxs)(t.li,{children:["Run the test YAML file using the CLI ",(0,r.jsx)(t.code,{children:"tracetest run test -f tests/test.yaml"}),"."]}),"\n",(0,r.jsx)(t.li,{children:"Follow the link to find the results."}),"\n"]}),"\n",(0,r.jsx)(t.h2,{id:"learn-more",children:"Learn More"}),"\n",(0,r.jsxs)(t.p,{children:["Check out our ",(0,r.jsx)(t.a,{href:"https://github.com/kubeshop/tracetest/tree/main/examples",children:"examples on GitHub"})," and join our ",(0,r.jsx)(t.a,{href:"https://dub.sh/tracetest-community",children:"Slack Community"})," for more info!"]})]})}function h(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},26376:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/terraform-output-028a487ecef4f57cbe2a47b172dc87d4.png"},13825:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/terraform-serverless-diagram-b26eedc20b44f4e41fc9d6df6aabbb1d.png"},28453:(e,t,n)=>{n.d(t,{R:()=>i,x:()=>o});var r=n(96540);const s={},a=r.createContext(s);function i(e){const t=r.useContext(a);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),r.createElement(a.Provider,{value:t},e.children)}}}]);